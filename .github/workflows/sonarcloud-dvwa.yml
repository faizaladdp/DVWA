name: ZAP Automation Framework Scan

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1️⃣ Create ZAP config folder and autorun file dynamically
      - name: Create ZAP config
        run: |
          mkdir -p zap-config
          cat <<'EOF' > zap-config/autorun.yaml
          env:
            contexts:
              - name: "Test Context"
                urls:
                  - "http://testphp.vulnweb.com"
          parameters:
            failOnError: false
            progressToStdout: true
          jobs:
            - type: spider
              parameters:
                context: "Test Context"
                maxDuration: 5
            - type: passiveScan-wait
            - type: report
              parameters:
                template: "traditional-html"
                reportDir: "reports"
                reportFile: "zap-report.html"
                reportTitle: "ZAP HTML Report"
                reportDescription: "OWASP ZAP automated scan"
              risks:
                - high
                - medium
                - low
                - info
              confidences:
                - high
                - medium
                - low
                - falsepositive
            - type: outputSummary
              parameters:
                format: "long"
                summaryFile: "/zap/reports/zap-summary.json"
          EOF

      # 2️⃣ Run the official ZAP Automation Framework Action
      - name: Run ZAP Automation Framework
        uses: MisterIcy/zap-automation-framework@v0.1.0
        with:
          config-dir: 'zap-config'
          autorun-file: 'autorun.yaml'
          reports-dir: 'reports'
          summary-file: 'zap-summary.json'
          create-annotations: true

      # 3️⃣ Upload reports as artifacts
      - name: Upload ZAP Reports
        uses: actions/upload-artifact@v4
        with:
          name: ZAP Reports
          path: reports/
